<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>

<head>
  <script type="text/javascript" src="/js/jquery.js"></script>
  <script type="text/javascript" src="/js/jquery.atmosphere.js"></script>
  <script type="text/javascript" src="/js/haed.notification.js"></script>
</head>

<body>

<br/><input class="topic" type="text" /><button class="subscribe" style="width: 80px">Subscribe</button>
<br/><input class="message" type="text" style="width: 400px" /><button class="send" style="width: 80px">Send</button>

<br/>
<button class="clear" style="width: 80px">Clear</button>
<button class="stress10" style="width: 80px">send 10 Messages</button>
<button class="stress100" style="width: 80px">send 100 Messages</button>
<button class="ping" style="width: 80px">ping</button>

<br/>
<div class="console"></div>


<script type="text/javascript">

/* clears output */
jQuery(".clear").click(function() {
    jQuery(".console").html("");
  });

var println = function(text) {
  jQuery(".console")
    .prepend(jQuery("<div>" + text + "</div>"));
};


// the channel to use
var channel;

var sendMessage = function(topic, message) {
  return jQuery.ajax("/haed.app1/send", {
        type: "GET", 
        data: { topic: topic, message: message }
      })
    .done(function() { println("send to " + topic + ": " + message); });
};

var sendMessages = function(max) {
  var topic = jQuery(".topic").val();
  for (var i = 1; i <= max; i++) {
    sendMessage(topic, "stress1, message " + i + "/" + max);
  }
};

jQuery(".stress10").click(function() { sendMessages(10); });
jQuery(".stress100").click(function() { sendMessages(100); });

jQuery(".ping").click(function() {
    channel.ping()
      .done(function() {
          alert("ping was successful")
        })
      .fail(function(error) {
          alert("ping failed: " + error)
        });
  });



// initializes the channel new channel (got new channelID from server)
haed.notification.createChannel()
  .done(function(_channel) {
  
      channel = _channel;
      
      println("created channel: " + channel.getID());
      
      jQuery(".subscribe").click(function() {
          var topic = jQuery(".topic").val();
          jQuery.ajax("/haed.app1/subscribe", {
                type: "GET", 
                data: {
                  channelID: channel.getID(), 
                  topic: topic
                }
              })
            .done(function() {
                channel.subscribe(topic, function(message) {
                  println("received: " + message);
                });
                println("subscribed to: " + topic);
              });
        });
      
      jQuery(".send").click(function() {
          sendMessage(jQuery(".topic").val(), jQuery(".message").val())
            .done(function() { jQuery(".message").val(""); });
        });
    });
  
</script>

</body>
</html>
